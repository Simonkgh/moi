<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Mine of Information - Some JUnit Test Rules</title>
    <link rel="stylesheet" type="text/css" href="/assets/css/coderay.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/stylesheet.css">
    <link type="application/atom+xml" title="Mine of Information" rel="alternate" href="/atom.xml"> 

    <meta name="generator" content="nanoc 4.12.15"> 
    <meta name="author" content="Simon Kitching"> 
  </head>
  <body>
    <section id="header">
      <span class='title'>The Mine of Information</span> <span class='desc'>(Nuggets of Programming and Linux)</span>
    </section>
    <div id="main">
      <section id='navpane'>
        <section>
  <ul id="navicons">
      <li class="nav">
      <a href="/" title="Home"><img src="/assets/images/Home.png"></a>
      <a href="/archives/" title="Archives"><img src="/assets/images/Calendar.png"></a>
      <a href="/site/welcome" title="E-Mail"><img src="/assets/images/Envelope.png"></a>
      <a href="/atom.xml" title="Subscribe Feed"><img src="/assets/images/RSS.png"></a>
      </li>
  </ul>
</section>

<section>
  <h1>About</h1>
  <ul id="about">
    <li>
      <a href="/site/welcome">Welcome</a>
    </li>
  </ul>
</section>

<section>
<h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2023/12/monorepos/">Monorepos and Polyrepos</a>
      </li>
    
      <li class="post">
        <a href="/2023/12/httpapis/">HTTP APIs, REST APIs, and Others</a>
      </li>
    
      <li class="post">
        <a href="/2023/09/biden/">Biden on Democracy</a>
      </li>
    
      <li class="post">
        <a href="/2023/09/tech-breadth/">Maintaining Technical Depth</a>
      </li>
    
      <li class="post">
        <a href="/2023/08/vpns/">The Uselessness of Consumer VPNs</a>
      </li>
    
      <li class="post">
        <a href="/2023/06/microservices/">Some Aspects of Implementing Microservices..</a>
      </li>
    
      <li class="post">
        <a href="/2023/06/dtest-evolution-scrum-monad/">DDD, Architecture patterns, and More..</a>
      </li>
    
      <li class="post">
        <a href="/2023/05/testing/">Should Unit Tests Verify Requirements Only?</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id="categories">
    
      <li class="catlink">
        <a href='/category/Architecture/'>Architecture</a>
      </li>
    
      <li class="catlink">
        <a href='/category/BigData/'>BigData</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Cloud/'>Cloud</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Cryptography/'>Cryptography</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Git/'>Git</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Infrastructure/'>Infrastructure</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Java/'>Java</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Links/'>Links</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Linux/'>Linux</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Network/'>Network</a>
      </li>
    
      <li class="catlink">
        <a href='/category/OSGi/'>OSGi</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Off-topic/'>Off-topic</a>
      </li>
    
      <li class="catlink">
        <a href='/category/OpenWRT/'>OpenWRT</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Programming/'>Programming</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Security/'>Security</a>
      </li>
    
      <li class="catlink">
        <a href='/category/Site/'>Site</a>
      </li>
    
  </ul>
</section>


      </section>
  
      <section id='content'>
        
  <div class='page'>
    <h1>Some JUnit Test Rules</h1>
    <aside>First published on: January 25, 2017</aside>
    
    <article>
    <p>Categories: <a href='/category/Programming/'>Programming</a>, <a href='/category/Java/'>Java</a></p>
      <h1 id="overview">Overview</h1>

<p>JUnit is one of the most widely-used frameworks for unit-testing Java code.</p>

<p>One of its features is the ability to associate “rule objects” with a test-class which are executed before and after each test. This article presents two reasonably simple <em>rule classes</em> I have implemented recently; one sets up a temporary folder on disk for the test to write to or read from, and the other allows tests to verify the logging output generated by tested code.</p>

<h1 id="junit-rules">JUnit Rules</h1>

<p>Every user of JUnit knows about <code>@Before</code> and <code>@After</code> methods on test-classes, which are invoked before and after each test. Rules provide similar functionality with a somewhat more elegant syntax. Alternatively, a JUnit rule can be described as an <em>interceptor</em> or <em>around advice</em> for test methods.</p>

<p>Given a class which extends <code>org.junit.rules.TestRule</code>, and a plain <em>member variable</em> of that type on the test-class annotated with @Rule, then the member’s “apply” method is invoked for each test-method, allowing it to perform setup/teardown and exception-handling for the test-method.</p>

<p>Multiple rule objects can be applied to the same test-class if needed.</p>

<h1 id="workdirrule">WorkdirRule</h1>

<p>This extremely simple but useful rule allows code like this:</p>

<pre><code>public class SomeTest {
  @Rule
  public WorkdirRule workdirRule = new WorkdirRule("sometest");

  @Test
  public void testSomething() {
    Path workdir = workdirRule.getDir();
    try(OutputStream os = Files.newOutputStream(workdir)) {
      os.write("hello, world".getBytes());
    }  

    ...
  }
}
</code></pre>

<p>A temporary directory is created before method testSomething is invoked, and is deleted afterwards.</p>

<p>The implementation of WorkdirRule is:</p>

<div class="CodeRay"><div class="code"><pre class="CodeRay">
<code class="language-java"><span class="comment">// Author Simon Kitching 2017.</span>
<span class="comment">// This software is in the public domain</span>
<span class="keyword">package</span> <span class="namespace">net.vonos.junit.rules</span>;

<span class="keyword">import</span> <span class="include">org.apache.commons.io.FileUtils</span>;
<span class="keyword">import</span> <span class="include">org.junit.rules.TestRule</span>;
<span class="keyword">import</span> <span class="include">org.junit.runner.Description</span>;
<span class="keyword">import</span> <span class="include">org.junit.runners.model.Statement</span>;

<span class="keyword">import</span> <span class="include">java.nio.file.Files</span>;
<span class="keyword">import</span> <span class="include">java.nio.file.Path</span>;

<span class="comment">/**
 * JUnit rule which creates a temporary directory (accessible via method getDir), runs a test, then deletes
 * the directory.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WorkdirRule</span> <span class="directive">implements</span> TestRule {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> prefix;
    <span class="directive">private</span> Path dir;

    <span class="directive">public</span> WorkdirRule(<span class="predefined-type">String</span> prefix) {
        <span class="local-variable">this</span>.prefix = prefix;
    }

    <span class="directive">public</span> Path getDir() {
        <span class="keyword">return</span> dir;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Statement</span> apply(<span class="predefined-type">Statement</span> statement, Description description) {
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Statement</span>() {
            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> evaluate() <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
                dir = Files.createTempDirectory(prefix);
                <span class="keyword">try</span> {
                    statement.evaluate();
                } <span class="keyword">finally</span> {
                    FileUtils.deleteDirectory(dir.toFile());
                }
            }
        };
    }
}</code>
</pre></div></div>

<h1 id="loginterceptrule">LogInterceptRule</h1>

<p>Perhaps assertions that a specific class being tested has <em>logged</em> messages with specific content is not in the best of taste, but sometimes it is necessary. If the application is using Logback as the concrete logging framework (and presumably SLF4J as the API to it), then this rule will allow writing such tests.</p>

<p>Because a large amount of logging may be generated for many different categories, this rule requires an annotation on each <em>test method</em> to indicate which categories (if any) should be captured and saved for later inspection. Example usage:</p>

<pre><code>public class SomeTest {
  @Rule
  public LogInterceptRule logRule = new LogInterceptRule();

  @Test
  @LogInterceptRule.forName("net.vonos.example")
  public void testSomething() {
    .. some code that logs to net.vonos.example ..
    Assert.assertEquals(2, logRule.getMessages().size());
    // The logRule has captured all output to the specified category so assertions can also test exact content if desired
  }
}
</code></pre>

<p>The implementation of LogInterceptRule is:</p>

<div class="CodeRay"><div class="code"><pre class="CodeRay">
<code class="language-java"><span class="comment">// Author Simon Kitching 2017.</span>
<span class="comment">// This software is in the public domain</span>
<span class="keyword">package</span> <span class="namespace">net.vonos.junit.rules</span>;

<span class="keyword">import</span> <span class="include">ch.qos.logback.classic.LoggerContext</span>;
<span class="keyword">import</span> <span class="include">ch.qos.logback.classic.PatternLayout</span>;
<span class="keyword">import</span> <span class="include">ch.qos.logback.classic.spi.ILoggingEvent</span>;
<span class="keyword">import</span> <span class="include">ch.qos.logback.core.UnsynchronizedAppenderBase</span>;
<span class="keyword">import</span> <span class="include">org.junit.rules.TestRule</span>;
<span class="keyword">import</span> <span class="include">org.junit.runner.Description</span>;
<span class="keyword">import</span> <span class="include">org.junit.runners.model.Statement</span>;
<span class="keyword">import</span> <span class="include">org.slf4j.LoggerFactory</span>;

<span class="keyword">import</span> <span class="include">java.lang.annotation.ElementType</span>;
<span class="keyword">import</span> <span class="include">java.lang.annotation.Retention</span>;
<span class="keyword">import</span> <span class="include">java.lang.annotation.RetentionPolicy</span>;
<span class="keyword">import</span> <span class="include">java.lang.annotation.Target</span>;
<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.locks.ReentrantLock</span>;

<span class="comment">/**
 * Junit rule to capture all logmessages to a specific logging category.
 * &lt;p&gt;
 * This assumes that the underlying logging implementation is logback-classic.
 * &lt;/p&gt;
 * &lt;p&gt;
 * Use as follows:
 * &lt;pre&gt;
 * @Rule
 * public final LogInterceptRule logRule = new LogInterceptRule();
 *
 * @Test
 * @LogInterceptRule.ForName("foo.bar")
 * public void testSomething() {
 *     ...
 *     Assert.assertEquals(2, logRule.getMessages().size());
 * }
 * &lt;/pre&gt;
 * &lt;/p&gt;
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LogInterceptRule</span> <span class="directive">implements</span> TestRule {
    <span class="directive">private</span> <span class="directive">final</span> MemAppender memAppender;

    <span class="comment">/** Constructor. */</span>
    <span class="directive">public</span> LogInterceptRule() {
        <span class="local-variable">this</span>.memAppender = <span class="keyword">new</span> MemAppender();
    }

    <span class="comment">/**
     * Return the captured messages without formatting (no level, category, stacktraces or variable-interpolation).
     */</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getRawMessages() {
        <span class="keyword">return</span> memAppender.rawMessages;
    }

    <span class="comment">/**
     * Return the captured messages with basic formatting, stacktraces and variable-interpolation.
     */</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getMessages() {
        <span class="keyword">return</span> memAppender.messages;
    }

    <span class="comment">/**
     * Implement the junit-rule-behaviour: return a closure whose evaluate() method will run the specified "base"
     * statement, with logging-logic wrapped around it.
     */</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Statement</span> apply(<span class="predefined-type">Statement</span> base, Description description) {
        memAppender.clear();

        <span class="predefined-type">String</span> catName = getCategory(description);
        <span class="keyword">if</span> (catName == <span class="predefined-constant">null</span>) {
            <span class="keyword">return</span> base;
        }

        ch.qos.logback.classic.Logger logger = (ch.qos.logback.classic.Logger) LoggerFactory.getLogger(catName);
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Statement</span>() {
            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> evaluate() <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
                logger.addAppender(memAppender);
                <span class="keyword">try</span> {
                    base.evaluate();
                } <span class="keyword">finally</span> {
                    logger.detachAppender(memAppender);
                }
            }
        };
    }

    <span class="comment">// ====================================================================================================</span>

    <span class="comment">/**
     * Annotation type that can be used to specify logging-category to be captured by string.
     */</span>
    <span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
    <span class="annotation">@Target</span>(<span class="predefined-type">ElementType</span>.METHOD)
    <span class="directive">public</span> <span class="annotation">@interface</span> ForName {
        <span class="predefined-type">String</span> value();
    }

    <span class="comment">/**
     * Annotation type that can be used to specify logging-category to be captured by class.
     */</span>
    <span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
    <span class="annotation">@Target</span>(<span class="predefined-type">ElementType</span>.METHOD)
    <span class="directive">public</span> <span class="annotation">@interface</span> ForClass {
        <span class="predefined-type">Class</span>&lt;?&gt; value();
    }

    <span class="comment">/**
     * Determine the logging-category to capture (if any) for a specific junit-test-method.
     */</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="predefined-type">String</span> getCategory(Description desc) {
        ForName fn = desc.getAnnotation(ForName.class);
        ForClass fc = desc.getAnnotation(ForClass.class);

        <span class="keyword">if</span> ((fn == <span class="predefined-constant">null</span>) &amp;&amp; (fc == <span class="predefined-constant">null</span>)) {
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }

        <span class="keyword">if</span> ((fn != <span class="predefined-constant">null</span>) &amp;&amp; (fc == <span class="predefined-constant">null</span>)) {
            <span class="keyword">return</span> fn.value();
        }

        <span class="keyword">if</span> ((fc != <span class="predefined-constant">null</span>) &amp;&amp; (fn == <span class="predefined-constant">null</span>)) {
            <span class="keyword">return</span> fc.value().getName();
        }

        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(<span class="string"><span class="delimiter">"</span><span class="content">Only one of ForName and ForClass may be specified</span><span class="delimiter">"</span></span>);
    }

    <span class="comment">/**
     * Custom SLF4J appender which saves messages into an in-memory list.
     * &lt;p&gt;
     * Only level WARN or above are kept. The logging format is hard-wired here so tests are not dependent
     * on the current logging configuration settings.
     * &lt;/p&gt;
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">MemAppender</span> <span class="directive">extends</span> UnsynchronizedAppenderBase&lt;ILoggingEvent&gt; {
        <span class="directive">protected</span> <span class="directive">final</span> <span class="predefined-type">ReentrantLock</span> lock = <span class="keyword">new</span> <span class="predefined-type">ReentrantLock</span>(<span class="predefined-constant">true</span>);
        <span class="directive">protected</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; rawMessages = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
        <span class="directive">protected</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; messages = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
        <span class="directive">private</span> <span class="directive">final</span> PatternLayout patternLayout;

        <span class="comment">// Minimal pattern without date, threadid, etc as these are not expected to be useful for tests.</span>
        <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PATTERN = <span class="string"><span class="delimiter">"</span><span class="content">%level %logger %msg%n</span><span class="delimiter">"</span></span>;

        <span class="directive">public</span> MemAppender() {
            <span class="comment">// Get the static app-wide context</span>
            LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory();

            patternLayout = <span class="keyword">new</span> PatternLayout();
            patternLayout.setContext(lc);
            patternLayout.setPattern(PATTERN);
            patternLayout.start();

            start();
        }

        <span class="directive">protected</span> <span class="type">void</span> clear() {
            rawMessages.clear();
            messages.clear();
        }

        <span class="annotation">@Override</span>
        <span class="directive">protected</span> <span class="type">void</span> append(ILoggingEvent e) {
            <span class="keyword">if</span> (!<span class="local-variable">this</span>.isStarted()) {
                <span class="keyword">return</span>;
            }

            <span class="keyword">if</span> (!e.getLevel().isGreaterOrEqual(ch.qos.logback.classic.Level.WARN)) {
                <span class="comment">// Filter out INFO and lower; tests are not expected to be interested in such things.</span>
                <span class="keyword">return</span>;
            }

            <span class="local-variable">this</span>.lock.lock();
            <span class="keyword">try</span> {
                rawMessages.add(e.getMessage());

                <span class="predefined-type">String</span> fm = patternLayout.doLayout(e);
                messages.add(fm);
            } <span class="keyword">finally</span> {
                <span class="local-variable">this</span>.lock.unlock();
            }
        }
    }
}</code>
</pre></div></div>


    </article>
  </div>
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'mineofinformation'; // mineofinformation (disqus site id)
      var disqus_pageid = '/java/junit-rules/'; // /relative/path/to/article/dir

      var disqus_config = function () {
        this.page.identifier = disqus_pageid;
        this.page.url = 'https://moi.vonos.net' + disqus_pageid;
      };
      (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  



      </section>
    </div>
    <section id="footer">
      <p>Copyright &copy; 2025 - Simon Kitching</p>
    </section>
  </body>
</html>

